apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "fathuss.fullname" . }}-secret-rotation
  labels:
    {{- include "fathuss.labels" . | nindent 4 }}
spec:
  schedule: "0 */6 * * *"  # Run every 6 hours
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: {{ include "fathuss.fullname" . }}-vault-auth
          containers:
          - name: secret-rotator
            image: vault:1.13.0
            command:
            - /bin/sh
            - -c
            - |
              # Rotate database credentials
              vault write -force database/rotate-role/fathuss-role

              # Rotate JWT secrets
              NEW_JWT_SECRET=$(openssl rand -base64 32)
              vault kv put kv/fathuss/jwt secret="$NEW_JWT_SECRET"

              # Rotate encryption keys
              NEW_ENCRYPTION_KEY=$(openssl rand -hex 32)
              vault kv put kv/fathuss/encryption key="$NEW_ENCRYPTION_KEY"

              # Rotate anti-cheat keys
              NEW_ANTI_CHEAT_KEY=$(openssl rand -hex 32)
              vault kv put kv/fathuss/anti-cheat key="$NEW_ANTI_CHEAT_KEY"

              echo "Secrets rotated successfully"
            env:
            - name: VAULT_ADDR
              value: "https://vault.fathuss.internal:8200"
            - name: VAULT_SKIP_VERIFY
              value: "false"
            volumeMounts:
            - name: vault-token
              mountPath: /vault/secrets
              readOnly: true
          volumes:
          - name: vault-token
            secret:
              secretName: {{ include "fathuss.fullname" . }}-vault-token
          restartPolicy: OnFailure
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "fathuss.fullname" . }}-ephemeral-token-generator
  labels:
    {{- include "fathuss.labels" . | nindent 4 }}
spec:
  template:
    spec:
      serviceAccountName: {{ include "fathuss.fullname" . }}-worker
      containers:
      - name: token-generator
        image: vault:1.13.0
        command:
        - /bin/sh
        - -c
        - |
          # Generate ephemeral token for worker node
          TOKEN_RESPONSE=$(vault token create -policy=fathuss-worker -ttl=1h -renewable=true -format=json)
          TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.auth.client_token')

          # Store token in Kubernetes secret for worker use
          kubectl create secret generic {{ include "fathuss.fullname" . }}-worker-token \
            --from-literal=token=$TOKEN \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "Ephemeral token generated for worker node"
        env:
        - name: VAULT_ADDR
          value: "https://vault.fathuss.internal:8200"
        volumeMounts:
        - name: vault-token
          mountPath: /vault/secrets
          readOnly: true
      volumes:
      - name: vault-token
        secret:
          secretName: {{ include "fathuss.fullname" . }}-vault-token
      restartPolicy: Never