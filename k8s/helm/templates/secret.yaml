apiVersion: v1
kind: Secret
metadata:
  name: {{ include "fathuss.fullname" . }}-secrets
  labels:
    {{- include "fathuss.labels" . | nindent 4 }}
  annotations:
    # Enable secret rotation
    secrets-manager.csi.akv.azure.com/rotation-enabled: "true"
    secrets-manager.csi.akv.azure.com/rotation-poll-interval: "2m"
type: Opaque
data:
  # JWT secrets - base64 encoded
  jwt-secret: {{ .Values.global.jwtSecret | default "eW91ci1zZWNyZXQta2V5" | b64enc }}
  jwt-refresh-secret: {{ .Values.global.jwtRefreshSecret | default "cmVmcmVzaC1zZWNyZXQta2V5" | b64enc }}

  # Database credentials
  database-url: {{ printf "postgresql://%s:%s@fathuss-postgresql:5432/%s" .Values.postgresql.auth.username .Values.postgresql.auth.password .Values.postgresql.auth.database | b64enc }}
  database-ssl-ca: {{ .Values.global.databaseSSLCa | default "" | b64enc }}
  database-ssl-cert: {{ .Values.global.databaseSSLCert | default "" | b64enc }}
  database-ssl-key: {{ .Values.global.databaseSSLKey | default "" | b64enc }}

  # ClickHouse credentials
  clickhouse-password: {{ .Values.clickhouse.env | toJson | fromJson | dig "CLICKHOUSE_PASSWORD" "password" | b64enc }}
  clickhouse-ssl-ca: {{ .Values.global.clickhouseSSLCa | default "" | b64enc }}

  # Redis credentials
  redis-password: {{ .Values.redis.auth.password | default "password" | b64enc }}
  redis-ssl-ca: {{ .Values.global.redisSSLCa | default "" | b64enc }}

  # RabbitMQ credentials
  rabbitmq-url: {{ printf "amqp://%s:%s@fathuss-rabbitmq:5672" .Values.rabbitmq.auth.username .Values.rabbitmq.auth.password | b64enc }}
  rabbitmq-management-url: {{ printf "http://%s:%s@fathuss-rabbitmq:15672" .Values.rabbitmq.auth.username .Values.rabbitmq.auth.password | b64enc }}

  # WalletConnect Project ID
  walletconnect-project-id: {{ .Values.global.walletConnectProjectId | default "dGVzdC1wcm9qZWN0LWlk" | b64enc }}

  # API Keys
  openai-api-key: {{ .Values.global.openaiApiKey | default "" | b64enc }}
  github-token: {{ .Values.global.githubToken | default "" | b64enc }}
  sentry-dsn: {{ .Values.global.sentryDSN | default "" | b64enc }}

  # Encryption keys
  encryption-key: {{ .Values.global.encryptionKey | default "ZW5jcnlwdGlvbi1rZXktZm9yLWRhdGE=" | b64enc }}
  anti-cheat-key: {{ .Values.global.antiCheatKey | default "YW50aS1jaGVhdC1zZWNyZXQ=" | b64enc }}

  # Monitoring and logging
  loki-username: {{ .Values.global.lokiUsername | default "admin" | b64enc }}
  loki-password: {{ .Values.global.lokiPassword | default "password" | b64enc }}

  # IPFS credentials (if needed)
  ipfs-private-key: {{ .Values.global.ipfsPrivateKey | default "" | b64enc }}

---
# TLS Certificate Secret
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "fathuss.fullname" . }}-tls
  labels:
    {{- include "fathuss.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
  tls.crt: {{ .Values.global.tlsCert | default "" | b64enc }}
  tls.key: {{ .Values.global.tlsKey | default "" | b64enc }}

---
# Docker Registry Secret
{{- if .Values.global.imagePullSecrets }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "fathuss.fullname" . }}-registry
  labels:
    {{- include "fathuss.labels" . | nindent 4 }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ .Values.global.dockerConfigJson | b64enc }}
{{- end }}

---
# HashiCorp Vault Secret Provider Class
{{- if .Values.vault.enabled }}
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: {{ include "fathuss.fullname" . }}-vault-provider
  labels:
    {{- include "fathuss.labels" . | nindent 4 }}
spec:
  provider: vault
  parameters:
    vaultAddress: {{ .Values.vault.address }}
    vaultSkipTLSVerify: {{ .Values.vault.skipTLSVerify | default "false" }}
    roleName: {{ .Values.vault.roleName | default "fathuss" }}
    objects: |
      - objectName: "database-creds"
        secretPath: "database/creds/fathuss-role"
        secretKey: "password"
      - objectName: "jwt-secret"
        secretPath: "kv/fathuss/jwt"
        secretKey: "secret"
      - objectName: "encryption-key"
        secretPath: "kv/fathuss/encryption"
        secretKey: "key"
      - objectName: "api-keys"
        secretPath: "kv/fathuss/api-keys"
        secretKey: "openai"
      - objectName: "anti-cheat-key"
        secretPath: "kv/fathuss/anti-cheat"
        secretKey: "key"
{{- end }}

---
# Azure Key Vault Secret Provider Class
{{- if .Values.azureKeyVault.enabled }}
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: {{ include "fathuss.fullname" . }}-akv-provider
  labels:
    {{- include "fathuss.labels" . | nindent 4 }}
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    userAssignedIdentityID: {{ .Values.azureKeyVault.userAssignedIdentityID }}
    keyvaultName: {{ .Values.azureKeyVault.name }}
    objects: |
      - objectName: jwt-secret
        objectType: secret
        objectVersion: ""
      - objectName: database-password
        objectType: secret
        objectVersion: ""
      - objectName: encryption-key
        objectType: secret
        objectVersion: ""
      - objectName: tls-cert
        objectType: secret
        objectVersion: ""
      - objectName: tls-key
        objectType: secret
        objectVersion: ""
    tenantId: {{ .Values.azureKeyVault.tenantId }}
{{- end }}