// Prisma schema for Leaderboard Service
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String   @id @default(uuid())
  address               String   @unique
  username              String?  @unique
  email                 String?  @unique
  avatarUrl             String?
  bio                   String?
  level                 Int      @default(1)
  experiencePoints      Int      @default(0)
  totalScore            Float    @default(0)
  challengesCompleted   Int      @default(0)
  reputation            Int      @default(0)
  currentStreak         Int      @default(0)
  longestStreak         Int      @default(0)
  lastActivityAt        DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  submissions           Submission[]
  achievements          UserAchievement[]
  dailyChallenges       UserDailyChallenge[]

  @@map("users")
}

model Challenge {
  id              String   @id @default(uuid())
  slug            String   @unique
  title           String
  category        String
  difficulty      String
  points          Int      @default(100)
  tags            String[]
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  submissions     Submission[]

  @@map("challenges")
}

model Submission {
  id              String   @id @default(uuid())
  challengeId     String
  challenge       Challenge @relation(fields: [challengeId], references: [id])
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  language        String
  status          String   @default("pending")
  score           Float?
  executionTime   Int?
  submittedAt     DateTime @default(now())
  completedAt     DateTime?

  @@index([challengeId, userId])
  @@index([status])
  @@map("submissions")
}

model Achievement {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  icon        String?
  category    String
  type        String   // "count", "streak", "score", "special"
  threshold   Int      // required value to unlock
  points      Int      @default(0)
  xpReward    Int      @default(0)
  rarity      String   @default("common") // "common", "rare", "epic", "legendary"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  users       UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  unlockedAt    DateTime @default(now())

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model DailyChallenge {
  id          String   @id @default(uuid())
  date        DateTime @unique
  title       String
  description String
  type        String   // "solve_challenge", "streak", "score"
  target      Int
  rewardXP    Int      @default(50)
  rewardPoints Int     @default(10)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  participants UserDailyChallenge[]

  @@map("daily_challenges")
}

model UserDailyChallenge {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  dailyChallengeId String
  dailyChallenge   DailyChallenge @relation(fields: [dailyChallengeId], references: [id])
  progress         Int      @default(0)
  completed        Boolean  @default(false)
  completedAt      DateTime?
  claimed          Boolean  @default(false)
  claimedAt        DateTime?

  @@unique([userId, dailyChallengeId])
  @@map("user_daily_challenges")
}